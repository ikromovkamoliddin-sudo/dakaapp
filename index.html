<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æç®€è‡ªå¾‹æ‰“å¡</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
      background: #000;
      color: #FFD700;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 30px 15px;
    }

    .container {
      width: 100%;
      max-width: 580px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 25px;
    }

    /* é¡µé¢å…±ç”¨ */
    .page {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 25px;
    }

    .hide {
      display: none;
    }

    /* æ ‡é¢˜å¤§å­— */
    .title {
      font-size: 40px;
      font-weight: bold;
      text-align: center;
    }

    .today-info {
      font-size: 18px;
      opacity: 0.9;
      text-align: center;
    }

    .quote {
      font-size: 17px;
      font-style: italic;
      opacity: 0.85;
      text-align: center;
      max-width: 90%;
    }

    /* è¿”å›æŒ‰é’® */
    .back-btn {
      padding: 12px 25px;
      background: #111;
      color: #FFD700;
      border: 1px solid #FFD700;
      font-size: 18px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
    }

    /* æ·»åŠ ä»»åŠ¡ */
    .add-box {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .add-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    input {
      flex: 1;
      min-width: 130px;
      padding: 15px;
      background: #111;
      color: #FFD700;
      border: 1px solid #FFD700;
      outline: none;
      font-size: 16px;
      border-radius: 8px;
    }

    .add-btn {
      padding: 15px;
      background: #FFD700;
      color: #000;
      border: none;
      font-size: 17px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
    }

    /* é¦–é¡µä»»åŠ¡å¡ç‰‡ */
    .task-list {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .task-item {
      background: #111;
      border: 1px solid #FFD700;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
    }

    /* è¯¦æƒ…é¡µè¿›åº¦ */
    .task-detail {
      width: 100%;
      text-align: center;
    }

    .detail-name {
      font-size: 30px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .detail-note {
      font-size: 18px;
      opacity: 0.85;
      margin-bottom: 20px;
    }

    .progress {
      width: 100%;
      height: 16px;
      background: #000;
      border: 1px solid #FFD700;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-bar {
      height: 100%;
      background: #FFD700;
      width: 0%;
      transition: width 0.6s ease;
    }

    .day-text {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 25px;
    }

    /* è¶…å¤§å®ŒæˆæŒ‰é’® */
    .done-btn {
      padding: 22px;
      background: #FFD700;
      color: #000;
      border: none;
      font-size: 24px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
    }

    .del-btn {
      margin-top: 15px;
      padding: 12px;
      background: #222;
      color: #FFD700;
      border: 1px solid #FFD700;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
    }

    /* æ‰“å¡æ—¥å†ï¼ˆè¯¦æƒ…é¡µï¼‰ */
    .calendar {
      width: 100%;
      background: #111;
      border: 1px solid #FFD700;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .calendar-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }

    .calendar-day {
      padding: 8px;
      font-size: 14px;
      border-radius: 6px;
      background: #000;
    }

    .calendar-day.done {
      background: #FFD700;
      color: #000;
      font-weight: bold;
    }

    /* çƒŸèŠ± & è¯ä¹¦ */
    #fireworks {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: none;
      z-index: 999;
    }

    .certificate {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #111;
      border: 2px solid #FFD700;
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      z-index: 1000;
      display: none;
    }

    .cert-title {
      font-size: 28px;
      margin-bottom: 20px;
    }

    .cert-close {
      margin-top: 20px;
      padding: 12px 25px;
      background: #FFD700;
      color: #000;
      border: none;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <canvas id="fireworks"></canvas>

  <!-- å®Œæˆè¯ä¹¦ -->
  <div class="certificate" id="cert">
    <div class="cert-title">ğŸ‰ ä»»åŠ¡å®Œæˆ ğŸ‰</div>
    <p id="certText" style="font-size:18px;"></p >
    <button class="cert-close" onclick="closeCert()">å…³é—­</button>
  </div>

  <div class="container">
    <!-- ========== ç¬¬1é¡µï¼šä»»åŠ¡åˆ—è¡¨ ========== -->
    <div class="page" id="page1">
      <div class="title">è‡ªå¾‹æ‰“å¡</div>
      <div class="today-info" id="nowDate"></div>
      <div class="quote" id="quote"></div>

      <div class="add-box">
        <div class="add-row">
          <input type="text" id="taskName" placeholder="è¾“å…¥ä»»åŠ¡åç§°">
          <input type="number" id="taskDays" placeholder="åšæŒå¤©æ•°" min="1">
          <input type="text" id="taskNote" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰">
        </div>
        <button class="add-btn" onclick="addTask()">â• æ·»åŠ æ–°ä»»åŠ¡</button>
      </div>

      <div class="task-list" id="taskList"></div>
    </div>

    <!-- ========== ç¬¬2é¡µï¼šå•ä¸ªä»»åŠ¡è¯¦æƒ…ï¼ˆè¿›åº¦+æ—¥å†+å®Œæˆï¼‰ ========== -->
    <div class="page hide" id="page2">
      <button class="back-btn" onclick="goBack()">â† è¿”å›ä»»åŠ¡åˆ—è¡¨</button>

      <div class="task-detail">
        <div class="detail-name" id="detailName"></div>
        <div class="detail-note" id="detailNote"></div>
        <div class="progress"><div class="progress-bar" id="detailBar"></div></div>
        <div class="day-text" id="detailDay"></div>
      </div>

      <!-- ä»»åŠ¡æ—¥å† -->
      <div class="calendar">
        <div class="calendar-title">æœ¬æœˆæ‰“å¡æ—¥å†</div>
        <div class="calendar-days" id="detailCal"></div>
      </div>

      <!-- è¶…å¤§å®ŒæˆæŒ‰é’® -->
      <button class="done-btn" id="doneBtn">âœ… ä»Šæ—¥å·²å®Œæˆ</button>
      <button class="del-btn" onclick="deleteCurrentTask()">ğŸ—‘ï¸ åˆ é™¤è¯¥ä»»åŠ¡</button>
    </div>
  </div>

  <script>
    // æ•°æ®å­˜å‚¨
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    let checkRecord = JSON.parse(localStorage.getItem('checkRecord')) || {}; // è®°å½•æ¯æ—¥æ‰“å¡
    let currentTaskId = null; // å½“å‰æ‰“å¼€çš„ä»»åŠ¡ID

    const fwCanvas = document.getElementById('fireworks');
    const ctx = fwCanvas.getContext('2d');

    // åŠ±å¿—è¯­å½•
    const quotes = [
      "åšæŒï¼Œæ˜¯æœ€å¥½çš„å¤©èµ‹", "è‡ªå¾‹ç»™æˆ‘è‡ªç”±", "æ—¥ç§¯æœˆç´¯ï¼Œæ°´æ»´çŸ³ç©¿",
      "ä»Šå¤©çš„åŠªåŠ›ï¼Œæ˜å¤©çš„å®åŠ›", "ä¸æ‹–å»¶ï¼Œä¸æ”¾å¼ƒ"
    ];

    // ä»Šæ—¥æ—¥æœŸï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦é‡å¤æ‰“å¡ï¼‰
    function getToday() {
      let d = new Date();
      return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
    }

    // åˆå§‹åŒ–
    window.onload = () => {
      showDate();
      showQuote();
      renderTaskList();
    };

    // æ˜¾ç¤ºæ—¥æœŸ
    function showDate() {
      let d = new Date();
      let week = ["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"][d.getDay()];
      document.getElementById('nowDate').innerText = 
        `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ Â· ${week}`;
    }

    // æ˜¾ç¤ºè¯­å½•
    function showQuote() {
      document.getElementById('quote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
    }

    // ä¿å­˜æ•°æ®
    function saveAll() {
      localStorage.setItem('tasks', JSON.stringify(tasks));
      localStorage.setItem('checkRecord', JSON.stringify(checkRecord));
    }

    // -------------------- é¡µé¢1ï¼šä»»åŠ¡åˆ—è¡¨ --------------------
    function renderTaskList() {
      let list = document.getElementById('taskList');
      list.innerHTML = '';
      tasks.forEach(t => {
        let item = document.createElement('div');
        item.className = 'task-item';
        item.innerText = t.name;
        item.onclick = () => openTaskDetail(t.id);
        list.appendChild(item);
      });
    }

    // æ·»åŠ ä»»åŠ¡
    function addTask() {
      let name = document.getElementById('taskName').value.trim();
      let days = Number(document.getElementById('taskDays').value);
      let note = document.getElementById('taskNote').value.trim();
      if (!name || !days || days < 1) {
        alert('è¯·å¡«å†™ä»»åŠ¡åç§°å’ŒåšæŒå¤©æ•°ï¼');
        return;
      }
      tasks.push({
        id: Date.now(), name, total: days, current: 1, note
      });
      document.getElementById('taskName').value = '';
      document.getElementById('taskDays').value = '';
      document.getElementById('taskNote').value = '';
      saveAll();
      renderTaskList();
    }

    // -------------------- é¡µé¢åˆ‡æ¢ --------------------
    function openTaskDetail(id) {
      currentTaskId = id;
      let task = tasks.find(t => t.id === id);
      if (!task) return;

      // å¡«ä»»åŠ¡ä¿¡æ¯
      document.getElementById('detailName').innerText = task.name;
      document.getElementById('detailNote').innerText = task.note || 'æ— å¤‡æ³¨';
      let per = (task.current / task.total) * 100;
      document.getElementById('detailBar').style.width = per + '%';
      document.getElementById('detailDay').innerText = `ç¬¬ ${task.current} å¤© / å…± ${task.total} å¤©`;

      // æ¸²æŸ“æ—¥å†
      renderCal();
      // åˆ¤æ–­ä»Šæ—¥æ˜¯å¦å·²æ‰“å¡
      checkTodayStatus();

      document.getElementById('page1').classList.add('hide');
      document.getElementById('page2').classList.remove('hide');
    }

    function goBack() {
      document.getElementById('page2').classList.add('hide');
      document.getElementById('page1').classList.remove('hide');
      renderTaskList();
    }

    // -------------------- æ‰“å¡é™åˆ¶ï¼šä»Šæ—¥åªèƒ½ä¸€æ¬¡ --------------------
    function checkTodayStatus() {
      let key = `${currentTaskId}_${getToday()}`;
      let btn = document.getElementById('doneBtn');
      if (checkRecord[key]) {
        btn.classList.add('hide'); // å·²æ‰“å¡ â†’ éšè—æŒ‰é’®
      } else {
        btn.classList.remove('hide'); // æœªæ‰“å¡ â†’ æ˜¾ç¤ºæŒ‰é’®
      }
    }

    // -------------------- å®Œæˆæ‰“å¡ï¼ˆçƒŸèŠ±+æŒ‰é’®éšè—ï¼‰ --------------------
    document.getElementById('doneBtn').onclick = () => {
      let task = tasks.find(t => t.id === currentTaskId);
      if (!task) return;

      // ä»»åŠ¡å·²å®Œæˆ
      if (task.current >= task.total) {
        showCert(task.name);
        playFireworks();
        return;
      }

      // ä»Šæ—¥æ‰“å¡
      let key = `${currentTaskId}_${getToday()}`;
      checkRecord[key] = 1;
      task.current++;
      saveAll();
      playFireworks();
      
      // åˆ·æ–°è¿›åº¦ + éšè—æŒ‰é’®
      let per = (task.current / task.total) * 100;
      document.getElementById('detailBar').style.width = per + '%';
      document.getElementById('detailDay').innerText = `ç¬¬ ${task.current} å¤© / å…± ${task.total} å¤©`;
      document.getElementById('doneBtn').classList.add('hide');
      renderCal();
    };

    // -------------------- æ—¥å† --------------------
    function renderCal() {
      let cal = document.getElementById('detailCal');
      cal.innerHTML = '';
      let d = new Date();
      let days = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
      for (let i=1; i<=days; i++) {
        let dateStr = `${d.getFullYear()}-${d.getMonth()+1}-${i}`;
        let key = `${currentTaskId}_${dateStr}`;
        let div = document.createElement('div');
        div.className = 'calendar-day' + (checkRecord[key] ? ' done' : '');
        div.innerText = i;
        cal.appendChild(div);
      }
    }

    // -------------------- çƒŸèŠ± & è¯ä¹¦ --------------------
    function playFireworks() {
      fwCanvas.style.display = 'block';
      fwCanvas.width = window.innerWidth;
      fwCanvas.height = window.innerHeight;
      let particles = [];
      for (let i=0; i<180; i++) {
        particles.push({
          x: fwCanvas.width/2, y: fwCanvas.height/2,
          vx: (Math.random()-0.5)*12, vy: (Math.random()-0.5)*12,
          life:130, color:`hsl(${45+Math.random()*15},100%,65%)`
        });
      }
      function draw() {
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.fillRect(0,0,fwCanvas.width,fwCanvas.height);
        let end = true;
        particles.forEach(p => {
          if (p.life <=0) return;
          end = false;
          ctx.fillStyle = p.color;
          ctx.beginPath(); ctx.arc(p.x,p.y,3.5,0,Math.PI*2); ctx.fill();
          p.x += p.vx; p.y += p.vy; p.vy += 0.13; p.life--;
        });
        end ? fwCanvas.style.display='none' : requestAnimationFrame(draw);
      }
      draw();
    }

    function showCert(name) {
      document.getElementById('certText').innerText = `æ­å–œä½ ï¼å·²å®Œæˆä»»åŠ¡ï¼š${name}ï¼\nåšæŒåˆ°åº•ï¼Œå°±æ˜¯èƒœåˆ©ï¼`;
      document.getElementById('cert').style.display = 'block';
    }

    function closeCert() {
      document.getElementById('cert').style.display = 'none';
    }

    // åˆ é™¤å½“å‰ä»»åŠ¡
    function deleteCurrentTask() {
      if (!confirm('ç¡®å®šåˆ é™¤è¯¥ä»»åŠ¡ï¼Ÿ')) return;
      tasks = tasks.filter(t => t.id !== currentTaskId);
      saveAll();
      goBack();
    }
  </script>
</body>
</html>
